variables:
  DOCKER_DRIVER: overlay2
  DOCKER_AUTH_CONFIG: $CI_DOCKER_AUTH_CONFIG
  NPM_REGISTRY: nexus3.tecna.pl/repository/npm-private-releases
  NPM_PROXY: nexus3.tecna.pl/repository/npm-private
  NPM_TOKEN: $TECNA_NPM_TOKEN
  UPSTREAM_REPO: $DOCKER_PROXY_URL
  DOWNSTREAM_REPO: $CI_REGISTRY
  UPSTREAM_REPO_USER: $NEXUS_USER
  UPSTREAM_REPO_PASSWORD: $NEXUS_PASSWORD

stages:
  - prepare
  #- storybook-tests
  - storybook-build
  - containerize
  - publish

#storybook-test:
#  image: mcr.microsoft.com/playwright:v1.52.0-noble
#  stage: storybook-tests
#  variables:
#    TZ: "Europe/Warsaw"
#  script:
#    - npm ci
#    - npm run build-storybook
#    - npx serve dist-storybook -l 6006 &
#    - sleep 15
#    - npm run test-storybook -- --maxWorkers=2 --testTimeout=30000 --ci --failOnConsole
#  only:
#    - dev

npm-install:
  stage: prepare
  image: docker.tecna.pl/node:lts
  script:
    - npm config set registry https://${NPM_PROXY}
    - npm set //${NPM_REGISTRY}:_authToken=${NPM_TOKEN}
    - npm set //${NPM_PROXY}:_authToken=${NPM_TOKEN}
    - npm install
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 week


build-storybook:
  stage: storybook-build
  image: docker.tecna.pl/node:lts
  dependencies:
    - npm-install
  script:
    - npm run build-storybook
  artifacts:
    paths:
      - storybook-static
  only:
    - dev

docker-push-storybook:
  stage: containerize
  image: docker.tecna.pl/docker
  dependencies:
    - build-storybook
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD ${DOWNSTREAM_REPO}
    - docker login -u $UPSTREAM_REPO_USER -p $UPSTREAM_REPO_PASSWORD ${UPSTREAM_REPO}
  script:
    - docker build -f Dockerfile.storybook --build-arg "NEXUS3_URL=${UPSTREAM_REPO}" -t ${DOWNSTREAM_REPO}/$GROUP_NAME/$APP_NAME:storybook .
    - docker push ${DOWNSTREAM_REPO}/$GROUP_NAME/$APP_NAME:storybook
  only:
    - dev



npm-publish:
  image: docker.tecna.pl/node:lts
  stage: publish
  script:
    - echo "$NPM_REGISTRY_CONFIG" > ~/.npmrc
    - npm install
    - npm run build
    - npm run publish:nexus
  only:
    - master




